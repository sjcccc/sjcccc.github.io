(window.webpackJsonp=window.webpackJsonp||[]).push([[3],{372:function(s,t,a){s.exports=a.p+"assets/img/TValue1.0f91423d.png"},373:function(s,t,a){s.exports=a.p+"assets/img/TValue2.fa45b005.png"},374:function(s,t,a){s.exports=a.p+"assets/img/TValue3.8bbb337c.png"},384:function(s,t,a){"use strict";a.r(t);var e=a(46),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"lua源码tvalue"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#lua源码tvalue"}},[s._v("#")]),s._v(" lua源码TValue")]),s._v(" "),e("h2",{attrs:{id:"设计思路"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#设计思路"}},[s._v("#")]),s._v(" 设计思路")]),s._v(" "),e("p",[s._v("Lua是一门动态类型的脚本语言，这意味着同一个变量可以在不同时刻指向不同类型的数据"),e("br"),s._v("\n这部分实现思路1是定义通用的base结构体"),e("br"),s._v(" "),e("img",{attrs:{src:a(372),alt:"TValue1"}}),e("br"),s._v("\n思路2是使用union共用体"),e("br"),s._v(" "),e("img",{attrs:{src:a(373),alt:"TValue2"}}),e("br"),s._v("\nlua使用的是第二种，C提供的union很适合处理这种情况")]),s._v(" "),e("h3",{attrs:{id:"union"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#union"}},[s._v("#")]),s._v(" union")]),s._v(" "),e("p",[s._v("结构体和共用体的区别在于："),e("br"),s._v("\n结构体的各个成员会占用不同的内存，互相之间没有影响；而共用体的所有成员占用同一段内存，修改一个成员会影响其余所有成员。"),e("br"),s._v("\n结构体占用的内存大于等于所有成员占用的内存的总和（成员之间可能会存在缝隙），共用体占用的内存等于最长的成员占用的内存。"),e("br"),s._v("\n共用体使用了内存覆盖技术，同一时刻只能保存一个成员的值，如果对新的成员赋值，就会把原来成员的值覆盖掉。")]),s._v(" "),e("h2",{attrs:{id:"实现"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#实现"}},[s._v("#")]),s._v(" 实现")]),s._v(" "),e("p",[s._v("lua使用了TValue来去实现同一个变量可以在不同时刻指向不同类型的数据这个功能")]),s._v(" "),e("div",{staticClass:"language-c extra-class"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*\n** Tagged Values. This is the basic representation of values in Lua,\n** an actual value plus a tag with its type.\n*/")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("TValuefields")]),s._v("\t"),e("span",{pre:!0,attrs:{class:"token expression"}},[s._v("Value value_"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" tt_")])]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("typedef")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("lua_TValue")]),s._v(" TValue"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("union")]),s._v(" Value "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  GCObject "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("gc"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("    "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* collectable objects */")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("p"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("         "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* light userdata */")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" b"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("           "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* booleans */")]),s._v("\n  lua_CFunction f"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* light C functions */")]),s._v("\n  numfield         "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* numbers */")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("lua_TValue")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  TValuefields"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),e("p",[s._v("可以看到TValue是lua_TValue结构体的一个别名，他有成员TValuefields，即Value类型的变量value_,和int类型的tt_"),e("br"),s._v("\nint tt_比较好理解，它负责储存TValue的类型")]),s._v(" "),e("div",{staticClass:"language-c extra-class"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*\n** basic types\n*/")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("LUA_TNONE")]),s._v("\t\t"),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")])])]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("LUA_TNIL")]),s._v("\t\t"),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")])])]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("LUA_TBOOLEAN")]),s._v("\t\t"),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")])])]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("LUA_TLIGHTUSERDATA")]),s._v("\t"),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")])])]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("LUA_TNUMBER")]),s._v("\t\t"),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")])])]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("LUA_TSTRING")]),s._v("\t\t"),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")])])]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("LUA_TTABLE")]),s._v("\t\t"),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")])])]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("LUA_TFUNCTION")]),s._v("\t\t"),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")])])]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("LUA_TUSERDATA")]),s._v("\t\t"),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")])])]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("LUA_TTHREAD")]),s._v("\t\t"),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")])])]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("LUA_NUMTAGS")]),s._v("\t\t"),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")])])]),s._v("\n")])])]),e("p",[s._v("在lua.h中定义好了这些lua中的类型"),e("br"),s._v("\nValue value_负责储存TValue的值"),e("br"),s._v("\n可以看到它包含了4中不需要进行gc的类型，void *p负责不需要gc的C数据，int b储存布尔变量，lua_CFunction f是c的方法，numfield为数字类型,是个double类型")]),s._v(" "),e("div",{staticClass:"language-c extra-class"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("numfield")]),s._v("\t"),e("span",{pre:!0,attrs:{class:"token expression"}},[s._v("lua_Number n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("    ")]),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* numbers */")])]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("LUA_NUMBER")]),s._v("\t"),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("double")])])]),s._v("\n")])])]),e("p",[s._v("还有个GCObject *gc是lua中需要进行gc的类型")]),s._v(" "),e("div",{staticClass:"language-c extra-class"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*\n** Union of all collectable objects\n*/")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("union")]),s._v(" GCObject "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  GCheader gch"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* common header */")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("union")]),s._v(" TString ts"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("union")]),s._v(" Udata u"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("union")]),s._v(" Closure cl"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Table")]),s._v(" h"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Proto")]),s._v(" p"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("UpVal")]),s._v(" uv"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("lua_State")]),s._v(" th"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* thread */")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),e("p",[s._v("它包括了TString lua的字符串，Udata u是需要gc的userdata，Closure cl是lua的闭包，Table h是lua的表（Proto p和UpVal uv后面在整理），lua_State th这个是thread"),e("br"),s._v("\nGCHeader是一个链表，用来储存所有需要gc的列表")]),s._v(" "),e("div",{staticClass:"language-c extra-class"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*\n** Common Header for all collectable objects (in macro form, to be\n** included in other objects)\n*/")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("define")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[s._v("CommonHeader")]),s._v("\t"),e("span",{pre:!0,attrs:{class:"token expression"}},[s._v("GCObject "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("next"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" lu_byte tt"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" lu_byte marked")])]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/*\n** Common header in struct form\n*/")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("typedef")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("GCheader")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  CommonHeader"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" GCheader"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),e("p",[s._v("这里的next就是指向下个可gc的object")]),s._v(" "),e("h3",{attrs:{id:"tvalue的结构图"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#tvalue的结构图"}},[s._v("#")]),s._v(" TValue的结构图")]),s._v(" "),e("p",[e("img",{attrs:{src:a(374),alt:"TValue3"}})])])}),[],!1,null,null,null);t.default=n.exports}}]);